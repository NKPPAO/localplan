<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<div class="header-gradient shadow-lg pb-32 pt-10 px-6 text-white">
  <div class="container mx-auto flex justify-between items-center">
    <div>
      <div class="flex items-center gap-3">
        <h1 id="mainTitle" class="text-2xl md:text-3xl font-bold tracking-tight">ระบบค้นหาโครงการตามแผนพัฒนาท้องถิ่น</h1>
        <button onclick="openSettingsModal()" class="thAdmin hidden p-1.5 bg-white/20 hover:bg-white/40 rounded-lg transition" title="แก้ไขข้อความ">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
          </svg>
        </button>
      </div>
      <p id="subTitle" class="opacity-80 text-sm mt-1">แผนพัฒนาท้องถิ่น (พ.ศ. 2571 - 2575) องค์การบริหารส่วนจังหวัดนครปฐม</p> 
      <div class="flex items-center space-x-2 mt-1">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-amber-500"></span>
        </span>
        <p class="text-[12px] text-amber-300">
          อัปเดตล่าสุด: <span id="lastUpdateText" class="font-medium text-amber-200 tracking-tight">...</span>
        </p>
      </div>  
    </div>
    <button onclick="toggleLoginModal(true)" id="adminBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl border border-white/30 transition backdrop-blur-md text-sm font-semibold">
    <svg xmlns="http://www.w3.org/2000/svg"
      class="w-4 h-4 inline -mt-1 mr-1"
      fill="none" viewBox="0 0 24 24"
      stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round"
      d="M16.5 10.5V6.75A4.5 4.5 0 0 0 7.5 6.75v3.75m-1.5 0h12
      a1.5 1.5 0 0 1 1.5 1.5v6a1.5 1.5 0 0 1-1.5 1.5h-12
      A1.5 1.5 0 0 1 4.5 18v-6A1.5 1.5 0 0 1 6 10.5z"/>
      </svg>
    </button>
  </div>
</div>

  <div class="container mx-auto px-4 -mt-24">
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <div onclick="filterByStatus('ยังไม่ได้ดำเนินการ')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-300 cursor-pointer hover:bg-slate-50 transition-all active:scale-95">
      <div class="text-slate-500 text-[14px] font-bold mb-1">ยังไม่ได้ดำเนินการ</div>
      <div id="stat1" class="text-2xl font-bold">0</div>
    </div>
    
    <div onclick="filterByStatus('อยู่ระหว่างดำเนินการ')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-500 cursor-pointer hover:bg-blue-50 transition-all active:scale-95">
      <div class="text-blue-500 text-[14px] font-bold mb-1">อยู่ระหว่างดำเนินการ</div>
      <div id="stat2" class="text-2xl font-bold">0</div>
    </div>

    <div onclick="filterByStatus('ดำเนินการแล้วเสร็จ')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-emerald-500 cursor-pointer hover:bg-emerald-50 transition-all active:scale-95">
      <div class="text-emerald-500 text-[14px] font-bold mb-1">ดำเนินการแล้วเสร็จ</div>
      <div id="stat3" class="text-2xl font-bold">0</div>
    </div>

    <div onclick="filterByStatus('ยกเลิก')" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-red-500 cursor-pointer hover:bg-red-50 transition-all active:scale-95">
      <div class="text-red-500 text-[14px] font-bold mb-1">ยกเลิก</div>
      <div id="stat4" class="text-2xl font-bold">0</div>
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow-xl p-5 mb-6 border border-slate-100">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 items-end">
    
    <div>
      <label class="text-[14px] font-bold text-slate-400 mb-1 block">เลือกอำเภอ</label>
      <select id="sAmphoe" onchange="filterData()" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        <option value="">ทั้งหมดทุกอำเภอ</option>
        <option value="เมืองนครปฐม">เมืองนครปฐม</option>
        <option value="นครชัยศรี">นครชัยศรี</option>
        <option value="สามพราน">สามพราน</option>
        <option value="ดอนตูม">ดอนตูม</option>
        <option value="บางเลน">บางเลน</option>
        <option value="กำแพงแสน">กำแพงแสน</option>
        <option value="พุทธมณฑล">พุทธมณฑล</option>
      </select>
    </div>

    <div>
      <label class="text-[14px] font-bold text-slate-400 mb-1 block">ชื่อ อปท.</label>
      <input type="text" id="sOpt" onkeyup="filterData()" placeholder="ชื่อ อปท..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
    </div>

    <div>
      <label class="text-[14px] font-bold text-slate-400 mb-1 block">ชื่อโครงการ</label>
      <input type="text" id="sProject" onkeyup="filterData()" placeholder="ค้นหาโครงการ..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
    </div>

    <div>
      <label class="text-[14px] font-bold text-slate-400 mb-1 block">สถานะ</label>
      <select id="sStatus" onchange="filterData()" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        <option value="">ทั้งหมด</option>
        <option>ยังไม่ได้ดำเนินการ</option>
        <option>อยู่ระหว่างดำเนินการ</option>
        <option>ดำเนินการแล้วเสร็จ</option>
        <option>ยกเลิก</option>
      </select>
    </div>

    <div class="lg:col-span-2 space-y-2">
  <div id="actionBtnContainer" class="flex gap-2 items-end h-full">
    
    <button onclick="clearSearch()" title="ล้างการค้นหา" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-500 py-2 rounded-xl transition-all flex items-center justify-center border border-slate-200 shadow-sm">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round"></path></svg>
    </button>
    
    <button onclick="exportToExcel()" title="Excel" class="flex-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-100 py-2 rounded-xl transition-all flex items-center justify-center shadow-sm">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"></path></svg>
    </button>

    <div id="planAdminBtn" class="contents"></div>
  </div>
</div>

  </div>
</div>

<div id="loadingLine" class="h-1 w-full overflow-hidden bg-slate-100 hidden">
    <div class="progress-line w-full h-full bg-blue-500"></div>
</div>

  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-10">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse min-w-full">
        <thead>
          <tr class="bg-slate-50 border-b border-slate-200">
            <th class="p-4 lg:hidden w-10 text-center"></th>
            <th class="p-4 w-12 text-center font-bold text-slate-500 text-[14px]">#</th>
            <th id="thCheckbox" class="p-4 w-10 text-center hidden">
  <input type="checkbox" id="checkAll" onclick="toggleCheckAll(this)" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
</th>
            <th class="p-4 font-bold text-slate-500 text-[14px] col-main">อำเภอ / อปท.</th>
            <th class="p-4 font-bold text-slate-500 text-[14px] hidden lg:table-cell">ชื่อโครงการ</th>
            <th class="p-4 font-bold text-slate-500 text-[14px] hidden sm:table-cell">อ้างอิงแผน</th>
            <th class="p-4 font-bold text-slate-500 text-[14px] text-center hidden md:table-cell">สถานะ</th>
            <th id="thAdmin" class="p-4 font-bold text-slate-500 text-[14px] text-center hidden">จัดการ</th>
          </tr>
        </thead>
        <tbody id="mainTable">
          <tr><td colspan="8" class="p-10 text-center">กำลังโหลดข้อมูล...</td></tr>
        </tbody>
      </table>
    </div>
    
    <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex flex-col md:flex-row items-center justify-between gap-4">
      <div id="pInfo" class="text-[13px] text-slate-500">พบข้อมูลทั้งหมด 0 รายการ</div>
      <nav id="paginationNav" class="inline-flex rounded-lg border border-slate-300 bg-white overflow-hidden shadow-sm"></nav>
    </div>
  </div>
</div>
<script>
  let filteredData = [];
  let isAdmin = false;
  let page = 1;
  let totalItems = 0;
  let totalPages = 0;
  const step = 50; 
  let editItem = null;
  let masterPlans = []; 
  let settings = {};

  const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });

  // 1. โหลดข้อมูลครั้งแรก
  window.onload = async () => {
    await loadSettings(); // โหลดหัวข้อเว็บ
    await loadPlans();    // โหลดรายชื่อเล่มแผน
    loadData(1);          // โหลดข้อมูลตาราง
    updateAdminUI();      // เช็คสถานะแอดมิน (ถ้ามีระบบ Login)
  };

  // ดึงค่าการตั้งค่าจาก MySQL
  async function loadSettings() {
    const res = await fetch('/api/settings');
    settings = await res.json();
    if(settings.header) document.querySelector('h1').innerText = settings.header; // สมมติว่ามี h1
  }

  // ดึงข้อมูล Master Plan จาก MySQL
  async function loadPlans() {
    const res = await fetch('/api/plans');
    masterPlans = await res.json();
    // ถ้ามี Select ให้เลือกเล่มแผนในหน้า Admin ให้เติมข้อมูลที่นี่
  }

  // --- ฟังก์ชันหลัก: ดึงข้อมูลจาก MySQL (แทนที่ google.script.run) ---
  async function loadData(targetPage = 1) {
    page = targetPage;
    
    const amp = document.getElementById('sAmphoe').value;
    const opt = document.getElementById('sOpt').value;
    const proj = document.getElementById('sProject').value;
    const stat = document.getElementById('sStatus').value;

    document.getElementById('loadingLine').classList.remove('hidden');

    try {
      // สร้าง Query String สำหรับส่งไปที่ Node.js
      const params = new URLSearchParams({
        searchTerm: proj || opt, // ค้นหาจากชื่อโครงการหรือ อปท.
        amp: amp,
        stat: stat,
        page: page,
        pageSize: step
      });

      const response = await fetch(`/api/projects?${params}`);
      const data = await response.json();

      filteredData = data.items;
      totalItems = data.totalCount;
      totalPages = data.totalPages;

      // อัปเดต Card สถิติจากข้อมูลที่ Server ส่งมา
      if (data.stats) {
        document.getElementById('stat1').innerText = (data.stats['ยังไม่ได้ดำเนินการ'] || 0).toLocaleString();
        document.getElementById('stat2').innerText = (data.stats['อยู่ระหว่างดำเนินการ'] || 0).toLocaleString();
        document.getElementById('stat3').innerText = (data.stats['ดำเนินการแล้วเสร็จ'] || 0).toLocaleString();
        document.getElementById('stat4').innerText = (data.stats['ยกเลิก'] || 0).toLocaleString();
      }

      render();
      document.getElementById('pInfo').innerText = `พบโครงการทั้งหมด ${totalItems} รายการ`;
    } catch (err) {
      console.error("Fetch error:", err);
      Toast.fire({ icon: 'error', title: 'การเชื่อมต่อฐานข้อมูลล้มเหลว' });
    } finally {
      document.getElementById('loadingLine').classList.add('hidden');
    }
  }

  // --- ฟังก์ชันอัปเดตข้อมูล (บันทึกการแก้ไข) ---
  async function submitEdit() {
    const id = editItem.id; // ใช้ id จาก MySQL
    const updatedData = {
      status: document.getElementById('editStatus').value,
      remark: document.getElementById('editNote').value
    };

    try {
      const res = await fetch(`/api/projects/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      });
      
      if (res.ok) {
        loadData(page); // โหลดข้อมูลหน้าปัจจุบันใหม่
        document.getElementById('editModal').classList.add('hidden');
        Toast.fire({ icon: 'success', title: 'บันทึกสำเร็จ' });
      }
    } catch (err) {
      Toast.fire({ icon: 'error', title: 'เกิดข้อผิดพลาดในการบันทึก' });
    }
  }

  // --- ฟังก์ชัน Export (เรียก API ดึงข้อมูลทั้งหมด) ---
  async function exportToExcel() {
    showLoading('กำลังเตรียมไฟล์ Excel...');
    // เรียก API แบบไม่ใส่ Limit เพื่อเอาข้อมูลทั้งหมดมาทำ Excel
    const params = new URLSearchParams({ pageSize: 10000 }); 
    const res = await fetch(`/api/projects?${params}`);
    const data = await res.json();

    const ws = XLSX.utils.json_to_sheet(data.items);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Projects");
    XLSX.writeFile(wb, `Report_${new Date().getTime()}.xlsx`);
    Swal.close();
  }

  // (ฟังก์ชัน render, createPagination, toggleChildRow ใช้โค้ดเดิมได้เลย)
</script>
  </body>
</html>
