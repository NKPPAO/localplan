<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<div class="header-gradient shadow-lg pb-32 pt-10 px-6 text-white">
  <div class="container mx-auto flex justify-between items-center">
    <div>
      <div class="flex items-center gap-3">
        <h1 id="mainTitle" class="text-2xl md:text-3xl font-bold tracking-tight">ระบบค้นหาโครงการตามแผนพัฒนาท้องถิ่น</h1>
        <button onclick="openSettingsModal()" class="thAdmin hidden p-1.5 bg-white/20 hover:bg-white/40 rounded-lg transition" title="แก้ไขข้อความ">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
          </svg>
        </button>
      </div>
      <p id="subTitle" class="opacity-80 text-sm mt-1">แผนพัฒนาท้องถิ่น (พ.ศ. 2571 - 2575) องค์การบริหารส่วนจังหวัดนครปฐม</p> 
      <div class="flex items-center space-x-2 mt-1">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-amber-500"></span>
        </span>
        <p class="text-[12px] text-amber-300">
          อัปเดตล่าสุด: <span id="lastUpdateText" class="font-medium text-amber-200 tracking-tight">...</span>
        </p>
      </div>  
    </div>
    <button onclick="toggleLoginModal(true)" id="adminBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl border border-white/30 transition backdrop-blur-md text-sm font-semibold">
    <svg xmlns="http://www.w3.org/2000/svg"
      class="w-4 h-4 inline -mt-1 mr-1"
      fill="none" viewBox="0 0 24 24"
      stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round"
      d="M16.5 10.5V6.75A4.5 4.5 0 0 0 7.5 6.75v3.75m-1.5 0h12
      a1.5 1.5 0 0 1 1.5 1.5v6a1.5 1.5 0 0 1-1.5 1.5h-12
      A1.5 1.5 0 0 1 4.5 18v-6A1.5 1.5 0 0 1 6 10.5z"/>
      </svg>
    </button>
  </div>
</div>
<script>
  let filteredData = [];
  let isAdmin = false;
  let page = 1;
  let totalItems = 0;
  let totalPages = 0;
  const step = 50; 
  let editItem = null;
  let masterPlans = []; 
  let settings = {};

  const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });

  // 1. โหลดข้อมูลครั้งแรก
  window.onload = async () => {
    await loadSettings(); // โหลดหัวข้อเว็บ
    await loadPlans();    // โหลดรายชื่อเล่มแผน
    loadData(1);          // โหลดข้อมูลตาราง
    updateAdminUI();      // เช็คสถานะแอดมิน (ถ้ามีระบบ Login)
  };

  // ดึงค่าการตั้งค่าจาก MySQL
  async function loadSettings() {
    const res = await fetch('/api/settings');
    settings = await res.json();
    if(settings.header) document.querySelector('h1').innerText = settings.header; // สมมติว่ามี h1
  }

  // ดึงข้อมูล Master Plan จาก MySQL
  async function loadPlans() {
    const res = await fetch('/api/plans');
    masterPlans = await res.json();
    // ถ้ามี Select ให้เลือกเล่มแผนในหน้า Admin ให้เติมข้อมูลที่นี่
  }

  // --- ฟังก์ชันหลัก: ดึงข้อมูลจาก MySQL (แทนที่ google.script.run) ---
  async function loadData(targetPage = 1) {
    page = targetPage;
    
    const amp = document.getElementById('sAmphoe').value;
    const opt = document.getElementById('sOpt').value;
    const proj = document.getElementById('sProject').value;
    const stat = document.getElementById('sStatus').value;

    document.getElementById('loadingLine').classList.remove('hidden');

    try {
      // สร้าง Query String สำหรับส่งไปที่ Node.js
      const params = new URLSearchParams({
        searchTerm: proj || opt, // ค้นหาจากชื่อโครงการหรือ อปท.
        amp: amp,
        stat: stat,
        page: page,
        pageSize: step
      });

      const response = await fetch(`/api/projects?${params}`);
      const data = await response.json();

      filteredData = data.items;
      totalItems = data.totalCount;
      totalPages = data.totalPages;

      // อัปเดต Card สถิติจากข้อมูลที่ Server ส่งมา
      if (data.stats) {
        document.getElementById('stat1').innerText = (data.stats['ยังไม่ได้ดำเนินการ'] || 0).toLocaleString();
        document.getElementById('stat2').innerText = (data.stats['อยู่ระหว่างดำเนินการ'] || 0).toLocaleString();
        document.getElementById('stat3').innerText = (data.stats['ดำเนินการแล้วเสร็จ'] || 0).toLocaleString();
        document.getElementById('stat4').innerText = (data.stats['ยกเลิก'] || 0).toLocaleString();
      }

      render();
      document.getElementById('pInfo').innerText = `พบโครงการทั้งหมด ${totalItems} รายการ`;
    } catch (err) {
      console.error("Fetch error:", err);
      Toast.fire({ icon: 'error', title: 'การเชื่อมต่อฐานข้อมูลล้มเหลว' });
    } finally {
      document.getElementById('loadingLine').classList.add('hidden');
    }
  }

  // --- ฟังก์ชันอัปเดตข้อมูล (บันทึกการแก้ไข) ---
  async function submitEdit() {
    const id = editItem.id; // ใช้ id จาก MySQL
    const updatedData = {
      status: document.getElementById('editStatus').value,
      remark: document.getElementById('editNote').value
    };

    try {
      const res = await fetch(`/api/projects/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      });
      
      if (res.ok) {
        loadData(page); // โหลดข้อมูลหน้าปัจจุบันใหม่
        document.getElementById('editModal').classList.add('hidden');
        Toast.fire({ icon: 'success', title: 'บันทึกสำเร็จ' });
      }
    } catch (err) {
      Toast.fire({ icon: 'error', title: 'เกิดข้อผิดพลาดในการบันทึก' });
    }
  }

  // --- ฟังก์ชัน Export (เรียก API ดึงข้อมูลทั้งหมด) ---
  async function exportToExcel() {
    showLoading('กำลังเตรียมไฟล์ Excel...');
    // เรียก API แบบไม่ใส่ Limit เพื่อเอาข้อมูลทั้งหมดมาทำ Excel
    const params = new URLSearchParams({ pageSize: 10000 }); 
    const res = await fetch(`/api/projects?${params}`);
    const data = await res.json();

    const ws = XLSX.utils.json_to_sheet(data.items);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Projects");
    XLSX.writeFile(wb, `Report_${new Date().getTime()}.xlsx`);
    Swal.close();
  }

  // (ฟังก์ชัน render, createPagination, toggleChildRow ใช้โค้ดเดิมได้เลย)
</script>
  </body>
</html>
